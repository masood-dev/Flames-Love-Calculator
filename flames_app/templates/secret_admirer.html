{% extends "layout.html" %}

{% block title %}Secret Admirer{% endblock %}

{% block content %}
<header>
    <h1>ðŸ’Œ Secret Admirer</h1>
    <p>Create a password-protected secret message!</p>
</header>

<main>
    <form id="secretNoteForm">
        <div class="input-group">
            <label for="senderName">From (Optional)</label>
            <input type="text" id="senderName" name="senderName" placeholder="Your secret identity..." maxlength="30">
        </div>

        <div class="input-group">
            <label for="message">Your Secret Message âœ¨</label>
            <textarea id="message" name="message" placeholder="Write your heartfelt message here..." required maxlength="500" rows="5"></textarea>
            <small id="charCount" style="color: #666; font-size: 0.85rem;">0 / 500 characters</small>
        </div>

        <div class="input-group">
            <label for="password">Set Password ðŸ”’</label>
            <input type="password" id="password" name="password" placeholder="Choose a password" required minlength="4">
            <small style="color: #666; font-size: 0.85rem;">Share this password with the recipient</small>
        </div>

        <button type="submit" id="createBtn">
            <span>Create Secret Note</span>
            <div class="liquid"></div>
        </button>
    </form>

    <!-- Success Message with Shareable Link -->
    <div id="result" class="result-container hidden">
        <div class="card">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸŽ‰</div>
            <h2>Secret Note Created!</h2>
            <p style="margin: 1rem 0;">Share this link with your special someone:</p>
            
            <div class="link-box">
                <input type="text" id="shareableLink" readonly style="background: rgba(255,255,255,0.8); border: 2px solid var(--primary-color); text-align: center; font-size: 0.9rem;">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 1rem;">
                <button id="copyBtn" style="flex: 1; background: var(--secondary-color);">
                    ðŸ“‹ Copy Link
                </button>
                <button id="createAnotherBtn" style="flex: 1; background: var(--primary-color);">
                    âœ¨ Create Another
                </button>
            </div>
            
            <p style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                ðŸ’¡ Don't forget to share the password too!
            </p>
        </div>
    </div>
</main>

{% block scripts %}
<script>
const form = document.getElementById('secretNoteForm');
const resultContainer = document.getElementById('result');
const shareableLink = document.getElementById('shareableLink');
const createBtn = document.getElementById('createBtn');
const messageInput = document.getElementById('message');
const charCount = document.getElementById('charCount');

// Character counter
messageInput.addEventListener('input', () => {
    const count = messageInput.value.length;
    charCount.textContent = `${count} / 500 characters`;
    charCount.style.color = count > 450 ? '#ff6b6b' : '#666';
});

// Form submission
form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const originalBtnText = createBtn.querySelector('span').innerText;
    createBtn.querySelector('span').innerText = 'Creating...';
    createBtn.disabled = true;

    const formData = {
        message: document.getElementById('message').value,
        password: document.getElementById('password').value,
        sender_name: document.getElementById('senderName').value || 'Someone Special'
    };

    try {
        const response = await fetch('/create-note', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            shareableLink.value = data.note_url;
            form.classList.add('hidden');
            resultContainer.classList.remove('hidden');
        } else {
            alert(data.error || 'Something went wrong!');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to create note. Please try again.');
    } finally {
        createBtn.querySelector('span').innerText = originalBtnText;
        createBtn.disabled = false;
    }
});

// Copy link button
document.getElementById('copyBtn').addEventListener('click', async () => {
    try {
        await navigator.clipboard.writeText(shareableLink.value);
        const btn = document.getElementById('copyBtn');
        const originalText = btn.innerText;
        btn.innerText = 'âœ… Copied!';
        setTimeout(() => btn.innerText = originalText, 2000);
    } catch (err) {
        shareableLink.select();
        document.execCommand('copy');
    }
});

// Create another note
document.getElementById('createAnotherBtn').addEventListener('click', () => {
    form.reset();
    charCount.textContent = '0 / 500 characters';
    form.classList.remove('hidden');
    resultContainer.classList.add('hidden');
});
</script>
{% endblock %}
